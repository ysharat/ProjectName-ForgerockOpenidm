-- -----------------------------------------------------
-- Table openidm.metaobjects
-- -----------------------------------------------------

CREATE TABLESPACE SOIDM34 MANAGED BY AUTOMATIC STORAGE;
CREATE TABLE SOPENIDM.METAOBJECTS (
    id                         INTEGER GENERATED BY DEFAULT AS IDENTITY ( CYCLE ),
    objecttypes_id             INTEGER        NOT NULL,
    objectid                   VARCHAR(255)   NOT NULL,
    rev                        VARCHAR(38)    NOT NULL,
    fullobject                 CLOB(2M),
    PRIMARY KEY (ID),
    CONSTRAINT FK_METAOBJECTS_OBJECTTYPES
        FOREIGN KEY (OBJECTTYPES_ID ) REFERENCES SOPENIDM.OBJECTTYPES (ID ) ON DELETE CASCADE) IN DOPENIDM.SOIDM34;
COMMENT ON TABLE SOPENIDM.METAOBJECTS IS 'OPENIDM - Generic table For Meta Objects';
CREATE INDEX SOPENIDM.FK_METAOBJECTS_OBJECTTYPES ON SOPENIDM.METAOBJECTS (OBJECTTYPES_ID ASC);
CREATE UNIQUE INDEX SOPENIDM.IDX_METAOBJECTS_OBJECT ON SOPENIDM.METAOBJECTS (OBJECTID ASC, OBJECTTYPES_ID ASC);

-- -----------------------------------------------------
-- Table openidm.metaobjectproperties
-- -----------------------------------------------------

CREATE TABLESPACE SOIDM35 MANAGED BY AUTOMATIC STORAGE;
CREATE TABLE SOPENIDM.METAOBJECTPROPERTIES (
    metaobjects_id          INTEGER        NOT NULL,
    propkey                    VARCHAR(255)   NOT NULL,
    proptype                   VARCHAR(255),
    propvalue                  VARCHAR(2000),
    PRIMARY KEY (metaobjects_id, propkey),
    CONSTRAINT FK_METAOBJECTPROPERTIES_METAOBJECTS
        FOREIGN KEY (METAOBJECTS_ID ) REFERENCES SOPENIDM.METAOBJECTS (ID)
        ON DELETE CASCADE
) IN DOPENIDM.SOIDM35;
COMMENT ON TABLE SOPENIDM.METAOBJECTPROPERTIES IS 'OPENIDM - Properties of Meta Objects';
CREATE INDEX SOPENIDM.IDX_METAOBJECTPROPERTIES_METAOBJECTS ON SOPENIDM.METAOBJECTPROPERTIES (METAOBJECTS_ID ASC);
CREATE INDEX SOPENIDM.IDX_METAOBJECTPROPERTIES_PROPKEY ON SOPENIDM.METAOBJECTPROPERTIES (PROPKEY ASC);
CREATE INDEX SOPENIDM.IDX_METAOBJECTPROPERTIES_PROPVALUE ON SOPENIDM.METAOBJECTPROPERTIES (PROPVALUE ASC);

-- -----------------------------------------------------
-- Migrate user meta data
-- -----------------------------------------------------
INSERT INTO SOPENIDM.METAOBJECTS (objecttypes_id, objectid, rev, fullobject)
  SELECT objecttypes_id, objectid, rev, fullobject
  FROM SOPENIDM.GENERICOBJECTS
    WHERE objecttypes_id = (SELECT id FROM SOPENIDM.OBJECTTYPES WHERE objecttype = 'internal/usermeta');

INSERT INTO SOPENIDM.METAOBJECTPROPERTIES (metaobjects_id, propkey, proptype, propvalue)
  SELECT SOPENIDM.METAOBJECTS.id, propkey, proptype, propvalue
  FROM SOPENIDM.METAOBJECTS
  JOIN SOPENIDM.GENERICOBJECTS ON SOPENIDM.METAOBJECTS.objectid = SOPENIDM.GENERICOBJECTS.objectid
    AND SOPENIDM.METAOBJECTS.objecttypes_id = SOPENIDM.GENERICOBJECTS.objecttypes_id
  JOIN SOPENIDM.GENERICOBJECTPROPERTIES ON SOPENIDM.GENERICOBJECTS.id = genericobjects_id;


-- -----------------------------------------------------
-- Remove old user meta data
-- WARNING: This is a permanent operation and the associated data will be permanently deleted!
-- -----------------------------------------------------
DELETE FROM SOPENIDM.GENERICOBJECTS
  WHERE objectid IN (SELECT objectid FROM SOPENIDM.METAOBJECTS)
  AND objecttypes_id = (SELECT id FROM SOPENIDM.OBJECTTYPES WHERE objecttype = 'internal/usermeta');
COMMIT;
